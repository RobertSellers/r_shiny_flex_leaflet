---
title: "U.S. Police Budget Analysis"
author: "Robert Sellers / Gloria DeSanker"
output:
  flexdashboard::flex_dashboard:
    theme: paper
    favicon: img/ios7-location-outline.png
runtime: shiny
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(dplyr)  # tidy data manipulation
library(leaflet)  # interative mapping
library(DT)  # interactive tables
library(sf) # Geospatial processing library
library(spData) # Geospatial datasets

# suppress scientific notation just in case
options(scipen=999)

# resolve promise
data("us_states")

# suppress warning / reproject states polygon to WGS84
us_states <- st_transform(us_states, crs = 4326)

# convert to financial data
us_states <- us_states %>%
  mutate(budget_10 = total_pop_10, budget_15 = total_pop_15)
```

```{r reactives}
# filter master dataframe columns by user variable select / radio select
mapFiltered  <- reactive({
  us_states[c("NAME",input$category)]
})
```


Column 
-------------------------------------
    
### Choropleth map
    
```{r map}
renderLeaflet({
  
  # constrain map to us_states polygon layer
  bounds <- us_states %>% 
    st_bbox() %>% 
    as.character()
  
  # define color gradient function
  # Using hardcoded bins on all values 
  bins <- c(0, 500000, 1000000, 2500000,5000000,10000000,15000000,20000000,Inf)
  pal<-  colorBin("YlOrRd", domain = mapFiltered()[[input$category]], bins = bins)
  
  if (nrow(mapFiltered()) == 0) {
    return(NULL)
  }

  # Prepare the text for tooltips:
  leaflet_tooltip <- sprintf(
  "<strong>%s</strong><br/>$%g",
  us_states$NAME, us_states[[input$category]]
) %>%
  lapply(htmltools::HTML)
  
  leaflet(mapFiltered()) %>%
    addProviderTiles("CartoDB.Positron") %>% 
    addPolygons(
      fillColor = ~ pal(mapFiltered()[[input$category]]),
      stroke = FALSE,
      fillOpacity = 0.6,
      
      label = leaflet_tooltip,
      labelOptions = labelOptions( 
        style = list("font-weight" = "normal", padding = "3px 8px"), 
        textsize = "13px", 
        direction = "auto"
      ),
      

    ) %>%
    addLegend(
      pal = pal, 
      values = ~mapFiltered()[[input$category]],
      opacity = 0.7, 
      title = input$category,
      labFormat = labelFormat(prefix = "$"),
        position = "bottomright"
    ) %>%
  fitBounds(bounds[1], bounds[2], bounds[3], bounds[4])
})
absolutePanel(
        draggable = TRUE, top = "1%", left = "auto", right = "1%", bottom = "auto",
        width = '30%', height = 'auto',
        p(strong("Available Choropleth analyses")),
        selectInput("category", label = "User Selection:", choices = c('budget_10','budget_15'), selected = "budget_10")
    )

```