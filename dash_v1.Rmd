---
title: "Leaflet Choropleth + Flexdashboard + DT"
author: "Robert Sellers"
output:
  flexdashboard::flex_dashboard:
    theme: paper
    favicon: img/ios7-location-outline.png
runtime: shiny
---

```{r setup, include=FALSE}
library(dplyr)  # tidy data manipulation
library(leaflet)  # interative mapping
library(DT)  # interactive tables
library(sf) # Geospatial processing library
library(spData) # Geospatial datasets

# observe({
#   mapFiltered()
#   leafletProxy("map", data = us_states) %>%
#   addProviderTiles("CartoDB.Positron") %>% 
#   clearShapes() %>% 
#   #clearControls() %>% 
#   addPolygons(data = us_states, fillColor = 'red', fillOpacity = 0.7, 
#             color = "white", weight = 2) 
# })

observe({
  mapFiltered()
  renderDataTable(mapFiltered())
})
  
```

Column {data-width=400}
-------------------------------------
```{r}
radioButtons("category", "Select a variable:",
            choices = c('total_pop_10','total_pop_15'),
            selected = "total_pop_10")
```

### Variable Selection
    
```{r mytable}
renderDataTable({
  DT::datatable(
  mapFiltered(),
  filter = "top",
  extensions = "Scroller",
  rownames = FALSE,
  style = "bootstrap",
  class = "compact",
  width = "100%",
  options = list(deferRender = TRUE, scrollY = 300, scroller = TRUE))
})
```


Column {data-width=600}
-------------------------------------
    
### Choropleth map
    
```{r map}

mapFiltered  <- reactive({
  us_states[c("NAME",input$category)]
})

# renderText({
#   input$category
# })
 
renderLeaflet({
  
  bounds <- us_states %>% 
    st_bbox() %>% 
    as.character()
  
  bins <- c(0, 1000000, 5000000,10000000,Inf)
        pal<-  colorBin("plasma", domain = mapFiltered()[[input$category]], bins = bins)
  
  if (nrow(mapFiltered()) == 0) {
    return(NULL)
  }

  leaflet(mapFiltered()) %>%
    addTiles() %>%
    setView(lng = 0, lat = 30, zoom = 2) %>%
    addPolygons(
      fillColor = ~ pal(mapFiltered()[[input$category]]),
      color = "white",
      fillOpacity = 0.7

    ) %>%
    addLegend(
      pal = pal, values = ~mapFiltered()[[input$category]],
      opacity = 0.7, title = input$category
    ) %>%
  fitBounds(bounds[1], bounds[2], bounds[3], bounds[4])
})

```